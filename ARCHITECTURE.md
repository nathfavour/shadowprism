# ShadowPrism System Architecture (v2.0 - Secure)

## 1. High-Level Overview

**ShadowPrism** is a privacy-first liquidity aggregator and infrastructure sidecar for the Solana ecosystem. It is designed to act as a "Privacy Proxy" for developers, AI Agents, and advanced power users, allowing them to route transactions through multiple privacy protocols programmatically.

The system utilizes a **Polyglot Sidecar Architecture**, leveraging **Go** for high-level orchestration, UI, and Agent logic, and **Rust** for low-level cryptographic operations and Solana program interactions.

### The "Sidecar" Pattern
To ensure maximum compatibility and performance, ShadowPrism runs as two distinct processes:
1.  **The Brain (CLI/Bot):** A lightweight Go process that handles user intent, routing strategies, and process management.
2.  **The Muscle (Core Engine):** A high-performance Rust daemon that executes the actual on-chain transactions via SDK integrations.

---

## 2. System Components

### A. The Interface Layer (Go)
*Located in: `/cli`*

The entry point for the user. It is built using the **Cobra** framework and serves three modes:
1.  **Interactive CLI:** A Terminal User Interface (TUI) built with **BubbleTea** for manual operations.
2.  **Telegram Bot:** An automated agent interface built with `telebot` for mobile/remote interaction.
3.  **Process Manager:** Responsible for locating, spawning, and managing the lifecycle of the Rust Core daemon.

**Key Improvements:**
* **Secure IPC Client:** Uses Unix Domain Sockets (UDS) on supported platforms with Bearer Token auth.
* **Embedded Binaries:** Uses `//go:embed` to package the Rust `shadowprism-core` binary for single-file distribution.

### B. The Engine Layer (Rust)
*Located in: `/core`*

The heavy lifter. It runs as a local HTTP server and holds the specific logic for interacting with various Solana privacy protocols.

**Key Improvements:**
* **State Management:** Uses a local SQLite store (`prism.db`) to track transaction lifecycle (Pending -> Confirmed -> Finalized).
* **Secure Keystore:** Implements an encrypted local keystore (AES-256-GCM) instead of raw ENV variables.

---

## 3. Data Flow & Communication

Communication between the **Brain** (Go) and **Muscle** (Rust) is secured to prevent local privilege escalation.

**IPC Method:** 
*   **Primary:** Unix Domain Sockets (`/tmp/shadowprism.sock`).
*   **Fallback:** TCP `localhost` with dynamic port negotiation.
**Authentication:** Static Bearer Token generated by the Go process at runtime and passed to Rust via `SHADOWPRISM_AUTH_TOKEN`.

### Flow: The "Shielding" Transaction
1.  **User Input:** User triggers `/shield 1 SOL` via Telegram Bot.
2.  **Orchestration (Go):**
    * Sidecar Manager ensures `shadowprism-core` is running and authenticated.
    * Bot sends `POST /v1/shield` with Auth header to the UDS.
3.  **Compliance (Rust):**
    * Middleware calls **Range Protocol** API with a circuit-breaker (fails open/closed based on config).
    * Results are cached for 1 hour to protect user privacy and reduce latency.
4.  **Execution (Rust):**
    * Engine constructs the instruction and persists the intent to `prism.db`.
    * Signs and broadcasts via Helius.
5.  **Feedback (Go):**
    * Go process receives immediate ACK with a `task_id`.
    * Go process polls `GET /v1/tasks/{id}` for real-time status updates until confirmation.

---

## 4. API Contract (Internal)

### `GET /health`
```json
{
  "status": "ready",
  "version": "2.0.0",
  "uds_enabled": true
}
```

### `POST /v1/shield`
Requires `Authorization: Bearer <token>`
```json
{
  "amount_lamports": 1000000000,
  "destination_addr": "BuX...7z",
  "strategy": "mix_standard"
}
```

---

## 5. Security Considerations

1.  **IPC Isolation:** By using Unix Domain Sockets with 0700 permissions, other local users cannot interact with the Rust Core API.
2.  **Zero-Leak Compliance:** Compliance checks are proxied and results cached to prevent wallet-address harvesting by third-party providers.
3.  **Encrypted Secrets:** Private keys are never stored in plain text. The Go CLI prompts for a "Prism Passphrase" to unlock the Rust engine's keystore at runtime.
4.  **Process Shielding:** The Go process monitors the Rust core; if the core is tampered with or crashes, the Go process clears sensitive memory and exits.

---

## 6. Directory Structure
```text
shadow-prism/
├── core/                   # [RUST] Secure Privacy Engine
│   ├── src/
│   │   ├── db/             # Persistence layer (SQLite)
│   │   ├── keystore/       # Encrypted key management
│   │   └── middleware/     # Auth & Compliance
│   └── Cargo.toml
└── cli/                    # [GO] CLI & Bot
    ├── internal/
    │   ├── embed/          # Embedded core binary
    │   └── ui/             # BubbleTea TUI
    └── main.go
```